<!DOCTYPE html>
<html lang="en">
<head>
    <title>Bench playground (use debugger)</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <link rel="stylesheet" href="css/main.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="js/generated/bench.js"></script>
</head>
<body>
<div class="help">
</div>

<canvas id="draw"></canvas>
<script>
    ( elem => {
        elem.height = window.innerHeight * 0.3;
        elem.width  = window.innerWidth * 0.8;
    })(document.getElementById("draw"))
</script>

<div class="config">
    minArg: <input class="num" id="minArg">
    maxArg: <input class="num" id="maxArg">
    maxTime (sec): <input class="num" id="maxTime" value="1">
    repeat: <input class="num" id="repeat">
    <button onclick="run()" class="run">compare!</button>
</div>

<div class="row collapsed" id="setup">
    <div class="left">
        <input readonly class="label" value="setup">
        <button onclick="toggleParent(this)">&gt;&gt;</button></div>
    <div class="right">
        <textarea class="code">
(n, cb) => cb(n)
        </textarea>
        <div class="error"></div>
    </div>
</div>

<div class="row solution">
    <div class="left">
        <input class="name label" value="solution">
        <button onclick="toggleParent(this)">&lt;&lt;</button>
    </div>
    <div class="right">
        <textarea class="code">
(n, cb) => {
    let head = null;
    while (n-->0)
        head = [head, n];
    cb(head);
}
        </textarea>
        <div class="error"></div>
    </div>
</div>

<div class="row solution">
    <div class="left">
        <input class="name label" value="other solution">
        <button onclick="toggleParent(this)">&lt;&lt;</button>
    </div>
    <div class="right">
        <textarea class="code">
(n, cb) => {
    let head = null;
    while (n-->0)
        head = {next: head, val: n};
    cb(head);
}
        </textarea>
        <div class="error"></div>
    </div>
</div>

<div class="row collapsed" id="teardown">
    <div class="left">
        <input readonly class="label" value="teardown">
        <button onclick="toggleParent(this)">&gt;&gt;</button>
    </div>
    <div class="right">
        <textarea class="code">
(retVal, cb) => {
    // check output validity here
    cb()
}
        </textarea>
        <div class="error"></div>
    </div>
</div>

<script>
    function toggleParent(elem) {
        const self = $(elem);
        const root = self.closest('.row');
        if (root.hasClass('collapsed')) {
            root.removeClass('collapsed');
            self.text('<<')
        } else {
            root.addClass('collapsed');
            self.text('>>')
        }
    }
</script>

<script>
    /* main */
    let chart;

    function run() {
        const variants = {};

        $('.solution').each( function() {
            const elem = $(this);
            const name = elem.find('.name').val();
            if (variants[name])
                return;
            const impl = prepareCode(elem);
            if (impl)
                variants[name] = impl;
        });

        if (Object.keys(variants).length === 0)
            return;

        const setup = prepareCode($('#setup'));
        const teardown = prepareCode($('#teardown'));

        if (!setup || !teardown)
            return;

        const bench = new ParaBench().setup(setup).teardown(teardown);

        const params = maybeNums({
            maxTime: $('#maxTime').val(),
            maxArg:  $('#maxArg').val(),
            minArg:  $('#minArg').val(),
            repeat:  $('#repeat').val(),
        });

        bench.compare({maxTime: 1, ...params}, variants).then(data => {
            console.log(data);
            const {n, times} = bench.flattenData(data);

            const datasets = Object.entries(times)
                    .map( pair => ({ label: pair[0], data: pair[1] }) );

            if (chart)
                chart.destroy();
            chart = new Chart('draw', {
                type: 'line',
                data: {
                    labels: n,
                    datasets,
                }
            })
        });
    }

    function prepareCode(elem) {
        const code = elem.find('.code').val();
        if (!code.match(/\S/))
            return;

        try {
            elem.removeClass('broken');
            elem.find('.error').text('');

            const impl = eval('' + code);
            if (typeof impl !== 'function')
                throw new Error("Input must be a function, not "+typeof impl);
            return impl;
        } catch (err) {
            elem.addClass('broken');
            elem.find('.error').text(err.toString());
        }
    }

    function maybeNums(hash) {
        const out = {};
        for (let name in hash) {
            const val = Number.parseFloat(hash[name]);
            if (Number.isFinite(val))
                out[name] = val;
        }
        return out;
    }

</script>
</body>
</html>
